(this["webpackJsonpjsnes-web"]=this["webpackJsonpjsnes-web"]||[]).push([[0],{39:function(t,e,a){t.exports=a(71)},51:function(t,e,a){},67:function(t,e,a){},68:function(t,e,a){},69:function(t,e,a){},70:function(t,e,a){},71:function(t,e,a){"use strict";a.r(e);var n=a(10),o=a.n(n),s=a(0),r=a.n(s),i=a(14),l=a.n(i),h=a(22),d=a(13),m=a(11),c=(a(51),a(73));var p={ROMS:{1942:{name:"1942",url:"/roms/classic/1942.nes"},mario:{name:"\u8d85\u7ea7\u739b\u4e3d",url:"https://lab.ur1.fun/FCGames/roms/classic/mario.nes"},owlia:{name:"\u5965\u8587\u5229\u4e9a\u4f20\u5947",url:"https://cdn.jsdelivr.net/gh/bfirsh/jsnes-roms@master/owlia.nes"},nomolos:{name:"Nomolos: Storming the Catsle",url:"https://cdn.jsdelivr.net/gh/bfirsh/jsnes-roms@master/nomolos.nes"},croom:{name:"Concentration Room",url:"https://cdn.jsdelivr.net/gh/bfirsh/jsnes-roms@master/croom/croom.nes"},lj65:{name:"LJ65",url:"https://cdn.jsdelivr.net/gh/bfirsh/jsnes-roms@master/lj65/lj65.nes"}},GOOGLE_ANALYTICS_CODE:Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).REACT_APP_GOOGLE_ANALYTICS_CODE,SENTRY_URI:Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).REACT_APP_SENTRY_URI};var u={getRomInfoByHash:function(t){return this.load().find(e=>e.hash===t)},save:function(t){return function(t){return new Promise((e,a)=>{var n=new FileReader;n.onload=e,n.readAsBinaryString(t)})}(t).then((function(t){const e=t.target.result;return function(t){const e=new ArrayBuffer(t.length);for(var a=new Uint8Array(e),n=0;n<t.length;n++)a[n]=t.charCodeAt(n);return crypto.subtle.digest("SHA-1",e).then(t=>Array.from(new Uint8Array(t)).map(t=>t.toString(16).padStart(2,"0")).join(""))}(e).then(t=>({hash:t,byteString:e}))})).then(({hash:e,byteString:a})=>{const n=localStorage.getItem("savedRomInfo"),o=n?JSON.parse(n):[],s={name:t.name,hash:e,added:Date.now()},r=JSON.stringify(o.concat([s]));return localStorage.setItem("savedRomInfo",r),localStorage.setItem("blob-"+e,a),s})},load:function(){return localStorage.getItem("savedRomInfo")&&JSON.parse(localStorage.getItem("savedRomInfo"))||[]},delete:function(t){const e=this.load();localStorage.removeItem("blob-"+t),localStorage.setItem("savedRomInfo",JSON.stringify(e.filter(e=>e.hash!==t)))}};class g extends s.Component{constructor(t){super(t),this.deleteRom=t=>{u.delete(t),this.updateLibrary()},this.updateLibrary=()=>{this.setState({romLibrary:u.load()})},this.handleDragOver=t=>{t.preventDefault(),t.dataTransfer.dropEffect="copy"},this.handleDrop=t=>{t.preventDefault();const e=t.dataTransfer.items?t.dataTransfer.items[0].getAsFile():t.dataTransfer.files[0];u.save(e).then(t=>{this.updateLibrary(),this.props.history.push({pathname:"run/local-"+t.hash})})},this.state={romLibrary:u.load()}}render(){return r.a.createElement("div",{className:"drop-zone",onDragOver:this.handleDragOver,onDrop:this.handleDrop},r.a.createElement("div",{className:"container ListPage py-4"},r.a.createElement("div",{className:"row justify-content-center"},r.a.createElement("div",{className:"col-md-8"},r.a.createElement("header",{className:"mb-4"},r.a.createElement("h1",{className:"mb-3"},"FC \u6e38\u620f\u5728\u7ebf\u73a9")),r.a.createElement(c.a,{className:"mb-4"},Object.keys(p.ROMS).sort().map(t=>r.a.createElement(d.b,{key:t,to:"/run/"+encodeURIComponent(t),className:"list-group-item"},p.ROMS[t].name,r.a.createElement("span",{className:"float-right"},"\u203a")))),r.a.createElement("p",null,"\u6ca1\u627e\u5230\u559c\u6b22\u7684\u6e38\u620f\uff1f\u76f4\u63a5\u5c06\u6e38\u620f NES ROM \u62d6\u52a8\u5230\u672c\u9875\u9762\u5373\u53ef\u5728\u7ebf\u8fd0\u884c"),this.state.romLibrary.length>0?r.a.createElement("div",null,r.a.createElement("p",null,"\u6700\u8fd1\u8fd0\u884c:"),r.a.createElement(c.a,{className:"mb-4"},this.state.romLibrary.sort((t,e)=>new Date(e.added)-new Date(t.added)).map(t=>r.a.createElement(d.b,{key:t.hash,to:"run/local-"+t.hash,className:"list-group-item"},t.name,r.a.createElement("span",{onClick:e=>{e.preventDefault(),this.deleteRom(t.hash)},className:"delete",title:"Delete"},"\xd7"),r.a.createElement("span",{className:"float-right"},"\u203a"))))):null))))}}var f=g,C=a(78),y=a(79),b=a(38),v=a(80),T=a(74),B=a(75),E=a(76),w=a(77),N=a(3);class S extends s.Component{constructor(t){super(t),this.state={playerOneButton:"",playerTwoButton:"",waitingForKey:0},this.handleClick=this.handleClick.bind(this)}componentDidMount(){var t=this.props.keys,e=this.props.button,a=[];for(var n in t)1===t[n][0]&&t[n][1]===e?(a[0]=t[n][2],console.log(a[0])):2===t[n][0]&&t[n][1]===e&&(a[1]=t[n][2]);this.setState({playerOneButton:a[0],playerTwoButton:a[1]})}componentDidUpdate(t,e){var a,n,o=this.props.keys,s=this.props.button,r=[];for(var i in o)1===o[i][0]&&o[i][1]===s?(r[0]=o[i][2],console.log(r[0])):2===o[i][0]&&o[i][1]===s&&(r[1]=o[i][2]);var l=(t,e)=>t.buttons.filter(t=>t.buttonId===e)[0],h=(t,e)=>e.buttons.filter(e=>!t||!t.buttons.some(t=>t.buttonId===e.buttonId))[0],d=0,m=0,c=t=>"button"===t.type?"Btn-"+t.code:"axis"===t.type?"Axis-"+t.code+" "+t.value:void 0;if(this.props.gamepadConfig&&this.props.gamepadConfig.playerGamepadId){const e=this.props.gamepadConfig.playerGamepadId;e[0]&&(r[0]="",a=l(this.props.gamepadConfig.configs[e[0]],s),n=h(t.gamepadConfig.configs[e[0]],this.props.gamepadConfig.configs[e[0]]),a?r[0]=c(a):n&&n.buttonId===this.props.prevButton&&(d||(d=1,m=1))),e[1]&&(r[1]="",a=l(this.props.gamepadConfig.configs[e[1]],s),n=h(t.gamepadConfig.configs[e[1]],this.props.gamepadConfig.configs[e[1]]),a?r[1]=c(a):n&&n.buttonId===this.props.prevButton&&(d||(d=2,m=2)))}var p={};d&&this.props.handleClick([m,this.props.button]),e.playerOneButton===r[0]&&e.playerTwoButton===r[1]||(p.playerOneButton=r[0],p.playerTwoButton=r[1]),d?p.waitingForKey=d:1===e.waitingForKey?this.props.currentPromptButton!==this.props.button&&(p.waitingForKey=0):2===e.waitingForKey&&this.props.currentPromptButton!==this.props.button&&(p.waitingForKey=0),Object.keys(p).length>0&&this.setState(p)}handleClick(t){this.props.handleClick([t,this.props.button]),this.setState({waitingForKey:t})}render(){return r.a.createElement("tr",null,r.a.createElement("td",null,this.props.buttonName),r.a.createElement("td",{onClick:()=>this.handleClick(1)},1===this.state.waitingForKey?"\u6309\u4e0b\u952e\u76d8\u8fdb\u884c\u8bbe\u7f6e...":this.state.playerOneButton),r.a.createElement("td",{onClick:()=>this.handleClick(2)},2===this.state.waitingForKey?"\u6309\u4e0b\u952e\u76d8\u8fdb\u884c\u8bbe\u7f6e...":this.state.playerTwoButton))}}var k=S;const O="../img/nes_controller.png";class I extends s.Component{constructor(t){super(t),this.state={gamepadConfig:t.gamepadConfig,keys:t.keys,button:void 0,modified:!1},this.handleKeyDown=this.handleKeyDown.bind(this),this.handleGamepadButtonDown=this.handleGamepadButtonDown.bind(this),this.listenForKey=this.listenForKey.bind(this),this.state.gamepadConfig=this.state.gamepadConfig||{},this.state.gamepadConfig.playerGamepadId=this.state.gamepadConfig.playerGamepadId||[null,null],this.state.gamepadConfig.configs=this.state.gamepadConfig.configs||{},this.state.controllerIcon=this.state.gamepadConfig.playerGamepadId.map(t=>t?O:"../img/keyboard.png"),this.state.controllerIconAlt=this.state.gamepadConfig.playerGamepadId.map(t=>t?"gamepad":"keyboard"),this.state.currentPromptButton=-1}componentWillUnmount(){this.state.modified&&(this.props.setKeys(this.state.keys),this.props.setGamepadConfig(this.state.gamepadConfig)),this.removeKeyListener()}listenForKey(t){var e=t[1];this.removeKeyListener(),this.setState({button:t,currentPromptButton:e}),this.props.promptButton(this.handleGamepadButtonDown),document.addEventListener("keydown",this.handleKeyDown)}handleGamepadButtonDown(t){this.removeKeyListener();var e=this.state.button;const a=e[0],n=e[1],o=t.gamepadId,s=this.state.gamepadConfig,r=s.playerGamepadId.slice(0),i={};r[a-1]=o;const l={code:t.code,type:t.type,buttonId:n,value:t.value};i[o]={buttons:(s.configs[o]||{buttons:[]}).buttons.filter(t=>t.buttonId!==n).concat([l])};const h=Object.assign({},s.configs,i);this.setState({gamepadConfig:{configs:h,playerGamepadId:r},currentPromptButton:-1,controllerIcon:r.map(t=>t?O:"../img/keyboard.png"),modified:!0})}handleKeyDown(t){this.removeKeyListener();var e=this.state.button,a=this.state.keys,n={};for(var o in a)a[o][0]===e[0]&&a[o][1]===e[1]||(n[o]=a[o]);const s=this.state.gamepadConfig.playerGamepadId.slice(0);s[e[0]-1]=null,this.setState({keys:Object(b.a)({},n,{[t.keyCode]:[...e.slice(0,2),t.key.length>1?t.key:String(t.key).toUpperCase()]}),button:void 0,gamepadConfig:{configs:this.state.gamepadConfig.configs,playerGamepadId:s},currentPromptButton:-1,controllerIcon:s.map(t=>t?O:"../img/keyboard.png"),controllerIconAlt:s.map(t=>t?"gamepad":"keyboard"),modified:!0})}removeKeyListener(){this.props.promptButton(null),document.removeEventListener("keydown",this.handleKeyDown)}render(){return r.a.createElement(v.a,{isOpen:this.props.isOpen,toggle:this.props.toggle,className:"ControlsModal"},r.a.createElement(T.a,{toggle:this.props.toggle},"\u952e\u76d8\u8bbe\u7f6e"),r.a.createElement(B.a,null,r.a.createElement(E.a,null,r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,"\u6309\u952e"),r.a.createElement("th",null,"\u73a9\u5bb6\u4e00",r.a.createElement("img",{className:"controller-icon",src:this.state.controllerIcon[0],alt:this.state.controllerIconAlt[0]})),r.a.createElement("th",null,"\u73a9\u5bb6\u4e8c",r.a.createElement("img",{className:"controller-icon",src:this.state.controllerIcon[1],alt:this.state.controllerIconAlt[1]})))),r.a.createElement("tbody",null,r.a.createElement(k,{buttonName:"\u2190",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_LEFT,prevButton:N.Controller.BUTTON_SELECT,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"\u2192",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_RIGHT,prevButton:N.Controller.BUTTON_LEFT,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"\u2191",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_UP,prevButton:N.Controller.BUTTON_RIGHT,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"\u2193",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_DOWN,prevButton:N.Controller.BUTTON_UP,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"A",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_A,prevButton:N.Controller.BUTTON_DOWN,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"B",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_B,prevButton:N.Controller.BUTTON_A,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"\u5f00\u59cb",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_START,prevButton:N.Controller.BUTTON_B,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig}),r.a.createElement(k,{buttonName:"\u5207\u6362",currentPromptButton:this.state.currentPromptButton,button:N.Controller.BUTTON_SELECT,prevButton:N.Controller.BUTTON_START,keys:this.state.keys,handleClick:this.listenForKey,gamepadConfig:this.state.gamepadConfig})))),r.a.createElement(w.a,null,r.a.createElement(C.a,{outline:!0,color:"primary",onClick:this.props.toggle},"\u5173\u95ed")))}}var D=I;class U{constructor(t){this.onAnimationFrame=t=>{this.requestAnimationFrame();let e=t%this.interval,a=t-e;if(!this.lastFrameTime)return void(this.lastFrameTime=a);let n=Math.round((a-this.lastFrameTime)/this.interval);if(0===n)return;this.generateFrame(),this.onWriteFrame();let o=this.interval-e;for(let s=1;s<n;s++)setTimeout(()=>{this.generateFrame()},s*o/n);n>1&&console.log("SKIP",n-1,this.lastFrameTime)},this.onGenerateFrame=t.onGenerateFrame,this.onWriteFrame=t.onWriteFrame,this.onAnimationFrame=this.onAnimationFrame.bind(this),this.running=!0,this.interval=1e3/60.098,this.lastFrameTime=!1}start(){this.running=!0,this.requestAnimationFrame()}stop(){this.running=!1,this._requestID&&window.cancelAnimationFrame(this._requestID),this.lastFrameTime=!1}requestAnimationFrame(){this._requestID=window.requestAnimationFrame(this.onAnimationFrame)}generateFrame(){this.onGenerateFrame(),this.lastFrameTime+=this.interval}}class F{constructor(t){this.disableIfGamepadEnabled=t=>{var e=this;return(a,n)=>{if(!e.gamepadConfig)return t(a,n);var o=e.gamepadConfig.playerGamepadId;return o&&o[a-1]?void 0:t(a,n)}},this._getPlayerNumberFromGamepad=t=>this.gamepadConfig.playerGamepadId[0]===t.id?1:this.gamepadConfig.playerGamepadId[1]===t.id?2:1,this.poll=()=>{const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),e=[];for(let a=0;a<t.length;a++){const n=t[a],o=this.gamepadState[a];if(!n)continue;if(!o){this.gamepadState[a]=n;continue}const s=n.buttons,r=o.buttons;if(this.buttonCallback){for(let t=0;t<n.axes.length;t++){const e=n.axes[t],a=o.axes[t];-1===e&&-1!==a&&this.buttonCallback({gamepadId:n.id,type:"axis",code:t,value:e}),1===e&&1!==a&&this.buttonCallback({gamepadId:n.id,type:"axis",code:t,value:e})}for(let t=0;t<s.length;t++){const e=s[t],a=r[t];e.pressed&&!a.pressed&&this.buttonCallback({gamepadId:n.id,type:"button",code:t})}}else if(this.gamepadConfig){let t=this._getPlayerNumberFromGamepad(n);if(e.length<2&&(-1!==e.indexOf(t)&&(t++,t>2&&(t=1)),e.push(t),this.gamepadConfig.configs[n.id])){const e=this.gamepadConfig.configs[n.id].buttons;for(let a=0;a<e.length;a++){const i=e[a];if("button"===i.type){const e=i.code,a=s[e],n=r[e];a.pressed&&!n.pressed?this.onButtonDown(t,i.buttonId):!a.pressed&&n.pressed&&this.onButtonUp(t,i.buttonId)}else if("axis"===i.type){const e=i.code,a=n.axes[e],s=o.axes[e];a===i.value&&s!==i.value&&this.onButtonDown(t,i.buttonId),a!==i.value&&s===i.value&&this.onButtonUp(t,i.buttonId)}}}}this.gamepadState[a]={buttons:s.map(t=>({pressed:t.pressed})),axes:n.axes.slice(0)}}},this.promptButton=t=>{this.buttonCallback=t?e=>{this.buttonCallback=null,t(e)}:t},this.loadGamepadConfig=()=>{var t;try{(t=localStorage.getItem("gamepadConfig"))&&(t=JSON.parse(t))}catch(e){console.log("Failed to get gamepadConfig from localStorage.",e)}this.gamepadConfig=t},this.setGamepadConfig=t=>{try{localStorage.setItem("gamepadConfig",JSON.stringify(t)),this.gamepadConfig=t}catch(e){console.log("Failed to set gamepadConfig in localStorage")}},this.startPolling=()=>{if(!navigator.getGamepads&&!navigator.webkitGetGamepads)return{stop:()=>{}};let t=!1;const e=()=>{t||(this.poll(),requestAnimationFrame(e))};return requestAnimationFrame(e),{stop:()=>{t=!0}}},this.onButtonDown=t.onButtonDown,this.onButtonUp=t.onButtonUp,this.gamepadState=[],this.buttonCallback=null}}const _={75:[1,N.Controller.BUTTON_A,"K"],74:[1,N.Controller.BUTTON_B,"J"],70:[1,N.Controller.BUTTON_SELECT,"F"],72:[1,N.Controller.BUTTON_START,"H"],87:[1,N.Controller.BUTTON_UP,"W"],83:[1,N.Controller.BUTTON_DOWN,"S"],65:[1,N.Controller.BUTTON_LEFT,"A"],68:[1,N.Controller.BUTTON_RIGHT,"D"],13:[2,N.Controller.BUTTON_A,"Enter"],99:[2,N.Controller.BUTTON_B,"3"],97:[2,N.Controller.BUTTON_SELECT,"1"],98:[2,N.Controller.BUTTON_START,"2"],38:[2,N.Controller.BUTTON_UP,"\u2191"],40:[2,N.Controller.BUTTON_DOWN,"\u2193"],37:[2,N.Controller.BUTTON_LEFT,"\u2190"],39:[2,N.Controller.BUTTON_RIGHT,"\u2192"]};class P{constructor(t){this.loadKeys=()=>{var t;try{(t=localStorage.getItem("keys"))&&(t=JSON.parse(t))}catch(e){console.log("Failed to get keys from localStorage.",e)}this.keys=t||_},this.setKeys=t=>{try{localStorage.setItem("keys",JSON.stringify(t)),this.keys=t}catch(e){console.log("Failed to set keys in localStorage")}},this.handleKeyDown=t=>{var e=this.keys[t.keyCode];e&&(this.onButtonDown(e[0],e[1]),t.preventDefault())},this.handleKeyUp=t=>{var e=this.keys[t.keyCode];e&&(this.onButtonUp(e[0],e[1]),t.preventDefault())},this.handleKeyPress=t=>{t.preventDefault()},this.onButtonDown=t.onButtonDown,this.onButtonUp=t.onButtonUp}}a(67);class x extends s.Component{constructor(...t){super(...t),this.setBuffer=t=>{for(var e=0,a=0;a<240;++a)for(var n=0;n<256;++n)e=256*a+n,this.buf32[e]=4278190080|t[e]},this.writeBuffer=()=>{this.imageData.data.set(this.buf8),this.context.putImageData(this.imageData,0,0)},this.fitInParent=()=>{let t=this.canvas.parentNode,e=t.clientWidth,a=t.clientHeight;256/240<e/a?(this.canvas.style.width="".concat(Math.round(a*(256/240)),"px"),this.canvas.style.height="".concat(a,"px")):(this.canvas.style.width="".concat(e,"px"),this.canvas.style.height="".concat(Math.round(e/(256/240)),"px"))},this.handleMouseDown=t=>{if(!this.props.onMouseDown)return;let e=256/parseFloat(this.canvas.style.width),a=this.canvas.getBoundingClientRect(),n=Math.round((t.clientX-a.left)*e),o=Math.round((t.clientY-a.top)*e);this.props.onMouseDown(n,o)}}render(){return r.a.createElement("canvas",{className:"Screen",width:256,height:240,onMouseDown:this.handleMouseDown,onMouseUp:this.props.onMouseUp,ref:t=>{this.canvas=t}})}componentDidMount(){this.initCanvas()}componentDidUpdate(){this.initCanvas()}initCanvas(){this.context=this.canvas.getContext("2d"),this.imageData=this.context.getImageData(0,0,256,240),this.context.fillStyle="black",this.context.fillRect(0,0,256,240),this.buf=new ArrayBuffer(this.imageData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf);for(var t=0;t<this.buf32.length;++t)this.buf32[t]=4278190080}screenshot(){var t=new Image;return t.src=this.canvas.toDataURL("image/png"),t}}var R=x,A=a(37),G=a.n(A);const K=(t,e)=>{console.error(t),o.a.captureException(t,{extra:e})};class L{constructor({onBufferUnderrun:t}){this.writeSample=(t,e)=>{this.buffer.size()/2>=this.bufferSize&&(console.log("Buffer overrun"),this.buffer.deqN(this.bufferSize/2)),this.buffer.enq(t),this.buffer.enq(e)},this.onaudioprocess=t=>{var e=t.outputBuffer.getChannelData(0),a=t.outputBuffer.getChannelData(1),n=e.length;this.buffer.size()<2*n&&this.onBufferUnderrun&&this.onBufferUnderrun(this.buffer.size(),2*n);try{var o=this.buffer.deqN(2*n)}catch(t){var s=this.buffer.size()/2;s>0&&console.log("Buffer underrun (needed ".concat(n,", got ").concat(s,")"));for(var r=0;r<n;r++)e[r]=0,a[r]=0;return}for(var i=0;i<n;i++)e[i]=o[2*i],a[i]=o[2*i+1]},this.onBufferUnderrun=t,this.bufferSize=8192,this.buffer=new G.a(2*this.bufferSize)}getSampleRate(){if(!window.AudioContext)return 44100;let t=new window.AudioContext,e=t.sampleRate;return t.close(),e}start(){window.AudioContext&&(this.audioCtx=new window.AudioContext,this.scriptNode=this.audioCtx.createScriptProcessor(1024,0,2),this.scriptNode.onaudioprocess=this.onaudioprocess,this.scriptNode.connect(this.audioCtx.destination))}stop(){this.scriptNode&&(this.scriptNode.disconnect(this.audioCtx.destination),this.scriptNode.onaudioprocess=null,this.scriptNode=null),this.audioCtx&&(this.audioCtx.close().catch(K),this.audioCtx=null)}}class M extends s.Component{constructor(...t){super(...t),this.start=()=>{this.frameTimer.start(),this.speakers.start(),this.fpsInterval=setInterval(()=>{console.log("FPS: ".concat(this.nes.getFPS()))},1e3)},this.stop=()=>{this.frameTimer.stop(),this.speakers.stop(),clearInterval(this.fpsInterval)}}render(){return r.a.createElement(R,{ref:t=>{this.screen=t},onGenerateFrame:()=>{this.nes.frame()},onMouseDown:(t,e)=>{this.nes.zapperMove(t,e),this.nes.zapperFireDown()},onMouseUp:()=>{this.nes.zapperFireUp()}})}componentDidMount(){this.fitInParent(),this.speakers=new L({onBufferUnderrun:(t,e)=>{this.props.paused||(console.log("Buffer underrun, running another frame to try and catch up"),this.frameTimer.generateFrame(),this.speakers.buffer.size()<e&&(console.log("Still buffer underrun, running a second frame"),this.frameTimer.generateFrame()))}}),this.nes=new N.NES({onFrame:this.screen.setBuffer,onStatusUpdate:console.log,onAudioSample:this.speakers.writeSample,sampleRate:this.speakers.getSampleRate()}),window.nes=this.nes,this.frameTimer=new U({onGenerateFrame:o.a.wrap(this.nes.frame),onWriteFrame:o.a.wrap(this.screen.writeBuffer)}),this.gamepadController=new F({onButtonDown:this.nes.buttonDown,onButtonUp:this.nes.buttonUp}),this.gamepadController.loadGamepadConfig(),this.gamepadPolling=this.gamepadController.startPolling(),this.keyboardController=new P({onButtonDown:this.gamepadController.disableIfGamepadEnabled(this.nes.buttonDown),onButtonUp:this.gamepadController.disableIfGamepadEnabled(this.nes.buttonUp)}),this.keyboardController.loadKeys(),document.addEventListener("keydown",this.keyboardController.handleKeyDown),document.addEventListener("keyup",this.keyboardController.handleKeyUp),document.addEventListener("keypress",this.keyboardController.handleKeyPress),this.nes.loadROM(this.props.romData),this.start()}componentWillUnmount(){this.stop(),document.removeEventListener("keydown",this.keyboardController.handleKeyDown),document.removeEventListener("keyup",this.keyboardController.handleKeyUp),document.removeEventListener("keypress",this.keyboardController.handleKeyPress),this.gamepadPolling.stop(),window.nes=void 0}componentDidUpdate(t){this.props.paused!==t.paused&&(this.props.paused?this.stop():this.start())}fitInParent(){this.screen.fitInParent()}}var j=M;a(68);class W extends s.Component{constructor(t){super(t),this.load=()=>{if(this.props.match.params.slug){const t=this.props.match.params.slug,e=/^local-/.test(t),a=t.split("-")[1],n=e?u.getRomInfoByHash(a):p.ROMS[t];if(!n)return void this.setState({error:"No such ROM: ".concat(t)});if(e){this.setState({romName:n.name});const t=localStorage.getItem("blob-"+a);this.handleLoaded(t)}else this.setState({romName:n.description}),this.currentRequest=function(t,e,a){var n=new XMLHttpRequest;return n.open("GET",t),n.overrideMimeType("text/plain; charset=x-user-defined"),n.onload=function(){if(200===this.status){if(n.responseText.match(/^<!doctype html>/i))return e(new Error("Page not found"));e(null,this.responseText)}else 0===this.status||e(new Error(n.statusText))},n.onerror=function(){e(new Error(n.statusText))},n.onprogress=a,n.send(),n}(n.url,(t,e)=>{t?this.setState({error:"Error loading ROM: ".concat(t.message)}):this.handleLoaded(e)},this.handleProgress)}else if(this.props.location.state&&this.props.location.state.file){let t=new FileReader;t.readAsBinaryString(this.props.location.state.file),t.onload=e=>{this.currentRequest=null,this.handleLoaded(t.result)}}else this.setState({error:"No ROM provided"})},this.handleProgress=t=>{t.lengthComputable&&this.setState({loadedPercent:t.loaded/t.total*100})},this.handleLoaded=t=>{this.setState({running:!0,loading:!1,romData:t})},this.handlePauseResume=()=>{this.setState({paused:!this.state.paused})},this.layout=()=>{let t=parseFloat(window.getComputedStyle(this.navbar).height);this.screenContainer.style.height="".concat(window.innerHeight-t,"px"),this.emulator&&this.emulator.fitInParent()},this.toggleControlsModal=()=>{this.setState({controlsModalOpen:!this.state.controlsModalOpen})},this.state={romName:null,romData:null,running:!1,paused:!1,controlsModalOpen:!1,loading:!0,loadedPercent:3,error:null}}render(){return r.a.createElement("div",{className:"RunPage"},r.a.createElement("nav",{className:"navbar navbar-expand",ref:t=>{this.navbar=t}},r.a.createElement("ul",{className:"navbar-nav",style:{width:"200px"}},r.a.createElement("li",{className:"navitem"},r.a.createElement(d.b,{to:"/",className:"nav-link"},"\u2039 \u8fd4\u56de"))),r.a.createElement("ul",{className:"navbar-nav ml-auto mr-auto"},r.a.createElement("li",{className:"navitem"},r.a.createElement("span",{className:"navbar-text mr-3"},this.state.romName))),r.a.createElement("ul",{className:"navbar-nav",style:{width:"200px"}},r.a.createElement("li",{className:"navitem"},r.a.createElement(C.a,{outline:!0,color:"primary",onClick:this.toggleControlsModal,className:"mr-3"},"\u952e\u76d8\u8bbe\u7f6e"),r.a.createElement(C.a,{outline:!0,color:"primary",onClick:this.handlePauseResume,disabled:!this.state.running},this.state.paused?"\u6062\u590d":"\u6682\u505c")))),this.state.error?this.state.error:r.a.createElement("div",{className:"screen-container",ref:t=>{this.screenContainer=t}},this.state.loading?r.a.createElement(y.a,{value:this.state.loadedPercent,style:{position:"absolute",width:"70%",left:"15%",top:"48%"}}):this.state.romData?r.a.createElement(j,{romData:this.state.romData,paused:this.state.paused,ref:t=>{this.emulator=t}}):null,this.state.controlsModalOpen&&r.a.createElement(D,{isOpen:this.state.controlsModalOpen,toggle:this.toggleControlsModal,keys:this.emulator.keyboardController.keys,setKeys:this.emulator.keyboardController.setKeys,promptButton:this.emulator.gamepadController.promptButton,gamepadConfig:this.emulator.gamepadController.gamepadConfig,setGamepadConfig:this.emulator.gamepadController.setGamepadConfig})))}componentDidMount(){window.addEventListener("resize",this.layout),this.layout(),this.load()}componentWillUnmount(){window.removeEventListener("resize",this.layout),this.currentRequest&&this.currentRequest.abort()}}var q=W;a(69);class z extends s.Component{constructor(t){super(t),this.recordPageview=({location:t})=>(h.a.pageview(t.pathname),null),this.state={error:null},p.GOOGLE_ANALYTICS_CODE&&h.a.initialize(p.GOOGLE_ANALYTICS_CODE)}render(){return this.state.error?r.a.createElement("div",{className:"container my-4"},r.a.createElement("div",{className:"row justify-content-center"},r.a.createElement("div",{className:"col-md-8"},"Oops - there has been an error. It has been logged to the console."))):r.a.createElement(d.a,null,r.a.createElement("div",{className:"App"},r.a.createElement(m.a,{exact:!0,path:"/",component:f}),r.a.createElement(m.a,{exact:!0,path:"/run",component:q}),r.a.createElement(m.a,{exact:!0,path:"/run/:slug",component:q}),r.a.createElement(m.a,{path:"/",render:this.recordPageview})))}componentDidCatch(t,e){this.setState({error:t}),K(t,e)}}var H=z;a(70);p.SENTRY_URI&&o.a.config(p.SENTRY_URI).install(),o.a.context((function(){l.a.render(r.a.createElement(H,null),document.getElementById("root"))}))}},[[39,1,2]]]);
//# sourceMappingURL=main.e0df947c.chunk.js.map